<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <script src="<!-- opencv.js -->" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="<!-- image-watch.css -->" />
</head>

<body>
    <div class="split-container">
        <div class="sidebar" id="thumbList">
            <div class="toolbar">
                <button id="btnLocal" class="toggle-btn selected">局部变量</button>
                <button id="btnWatch" class="toggle-btn">监视</button>
            </div>

            <div class="sidebar" id="varList">
                <!-- 这里可以动态生成局部变量或监视列表 -->
            </div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="main" id="mainView">
            <div class="main" id="currentImage">
                <!-- 这里显示当前选中的图片 -->
                <canvas id="mainCanvas" style="max-width: 90%; max-height: 90%;"> </canvas>
                <div id="placeholder" class="placeholder">[无选择]</div>
            </div>
        </div>
    </div>
    <script>
        let cvReady = false;
        let cvInstance = null;

        if (window.cv && typeof window.cv.then === 'function') {
            console.log('OpenCV.js 加载');
            // 新版异步加载
            window.cv.then((cv) => {
                cvReady = true;
                cvInstance = cv;
                console.log('OpenCV.js 已加载完成', cv);
                // 你可以在这里注册 message 事件，或设置全局 ready 标志
                window.cv['onRuntimeInitialized'] = () => {
                    console.log('OpenCV.js Runtime Initialized');
                };
            });
        } else {
            console.log('OpenCV.js onRuntimeInitialized 加载');
            // 传统同步加载
            window.cv['onRuntimeInitialized'] = () => {
                cvReady = true;
                cvInstance = window.cv;
                console.log('OpenCV.js 已加载完成', window.cv);
            };
        }

        // 监听器函数
        window.addEventListener('message', event => {
            console.log('Received message:', event);
            if (!event.data || !event.data.command) {
                console.error('Invalid message format:', event);
                return;
            }
            if (event.data.command != 'add_variable') {
                console.error('Unknown message type:', event.data.type);
                return;
            }

            // 处理变量数据
            const { mat, variable_name, memory } = event.data;
            const mat_is_submat = mat.flags & 0x4000; // CV_MAT_SUBMATRIX_FLAG
            const mat_is_continuous = mat.flags & 0x200; // CV_MAT_CONT_FLAG
            const mat_type = mat.flags & 0xFFF;
            console.log('Variable name:', variable_name);
            console.log('memory:', memory);
            console.log('mat:', mat);

            // 等待 opencv.js 加载完成
            if (!cvReady) {
                console.error('OpenCV.js 尚未加载完成');
                return;
            }
            console.log('mat.type:', mat_type, typeof mat.flags);

            let image = null;
            // 处理 Mat 引用其他 Mat 的部分区域的情况
            if (!mat_is_submat) {
                console.warn('Mat is not continuous, converting to continuous Mat');
                // 如果不是连续的 Mat，通过 addr.start 和 addr.end 获取连续内存
                const use_addr = mat.data.addr;
                const addr = mat.datastart.addr;
                const size = mat.dataend.addr - addr;
                const skip = use_addr - addr;
                const ref_cols = mat.step[0];
                const ref_rows = size / ref_cols;
                console.log('Reference rows:', ref_rows, 'Reference cols:', ref_cols);
                console.log('Mat address:', addr, 'Size:', size, 'Skip:', skip);
                let pos = [Math.floor(skip / ref_cols), Math.floor(skip % ref_cols)];
                console.log('Mat position:', pos);
                // 创建一个新的连续 Mat
                const ref_mat = new cvInstance.matFromArray(
                    ref_rows, ref_cols, mat_type, memory
                );
                console.log('Creating cv.Mat from memory:', ref_mat);
                const roi = new cvInstance.Rect(pos[1], pos[0], mat.cols, mat.rows);
                console.log('Creating ROI:', roi);
                // 使用 ROI 创建新的 Mat
                let roi_mat = ref_mat.roi(roi);
                console.log('New Mat after ROI:', roi_mat);
                image = roi_mat.clone();
                // 清理临时 Mat
                ref_mat.delete();
                roi_mat.delete();
            }
            else {
                console.log('Mat is continuous, using it directly');
                // 如果是连续的 Mat，直接使用
                image = new cvInstance.matFromArray(mat.rows, mat.cols, mat_type, memory);
            }
            console.log('Creating cv.Mat from memory:', image);
            // 统一转为 CV_8UC4
            // 先处理浮点数类型
            if (image.type() === cvInstance.CV_32FC1 || image.type() === cvInstance.CV_32FC3) {
                console.log('Converting CV_32F to CV_8UC4');
                image.convertTo(image, cvInstance.CV_8UC4, 255.0);
            } else if (image.type() === cvInstance.CV_8UC1) {
                console.log('Converting CV_8UC1 to CV_8UC4');
                let temp = new cvInstance.Mat();
                cvInstance.cvtColor(image, temp, cvInstance.COLOR_GRAY2RGBA);
                image.delete();
                image = temp;
            } else if (image.type() === cvInstance.CV_8UC3) {
                console.log('Converting CV_8UC3 to CV_8UC4');
                let temp = new cvInstance.Mat();
                cvInstance.cvtColor(image, temp, cvInstance.COLOR_RGB2RGBA);
                image.delete();
                image = temp;
            } else if (image.type() !== cvInstance.CV_8UC4) {
                console.error('Unsupported mat type:', image.type());
                return;
            }

            const canvas = document.getElementById('mainCanvas');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Failed to get canvas context');
                return;
            }
            canvas.width = mat.cols;
            canvas.height = mat.rows;
            const imageData = new ImageData(
                new Uint8ClampedArray(image.data),
                image.cols,
                image.rows
            );
            ctx.putImageData(imageData, 0, 0);

            // 清理 cv.Mat
            image.delete();
            console.log('ImageData drawn on canvas:', canvas);
        });

        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('thumbList');
        let isResizing = false;

        resizer.addEventListener('mousedown', function (e) {
            isResizing = true;
            document.body.style.cursor = 'ew-resize';
        });

        document.addEventListener('mousemove', function (e) {
            if (!isResizing) return;
            const min = 100, max = window.innerWidth - 100;
            let newWidth = Math.min(Math.max(e.clientX, min), max);
            sidebar.style.width = newWidth + 'px';
        });

        document.addEventListener('mouseup', function () {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
            }
        });


        // 互斥按钮逻辑
        const btnLocal = document.getElementById('btnLocal');
        const btnWatch = document.getElementById('btnWatch');
        btnLocal.onclick = () => {
            btnLocal.classList.add('selected');
            btnWatch.classList.remove('selected');
            // TODO: 切换到局部变量数据
        };
        btnWatch.onclick = () => {
            btnWatch.classList.add('selected');
            btnLocal.classList.remove('selected');
            // TODO: 切换到监视数据
        };

        // 示例图片数据
        const images = [
            { name: "图片1", src: "https://via.placeholder.com/120x80?text=1", desc: "cv::Mat" },
            { name: "图片2", src: "https://via.placeholder.com/120x80?text=2", desc: "cv::Mat" },
            { name: "图片3", src: "https://via.placeholder.com/120x80?text=3", desc: "cv::Mat" },
            { name: "图片4", src: "https://via.placeholder.com/120x80?text=3", desc: "cv::Mat" }
        ];

        const varList = document.getElementById('varList');
        const currentImage = document.getElementById('currentImage');

        function renderThumbs() {
            varList.innerHTML = '';
            images.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = 'thumb';
                div.innerHTML = `
            <img src = "${img.src}" alt = "${img.name}">
                <div class="info" >
                    <div>${img.name} </div>
                        <div style = "font-size:12px;color:#888;"> ${img.desc} </div>
                            </div>
                                `;
                div.onclick = () => selectImage(idx);
                varList.appendChild(div);
            });
        }

        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;

        function updateTransform() {
            const img = document.getElementById('mainImg');
            if (img) {
                img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
            }
        }

        currentImage.addEventListener('wheel', (e) => {
            e.preventDefault();
            // 缩放
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            scale = Math.max(0.1, scale + delta);
            updateTransform();
        }, { passive: false });

        currentImage.addEventListener('mousedown', (e) => {
            const img = document.getElementById('mainImg');
            if (!img) return;
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            img.style.cursor = 'grabbing';
        });

        currentImage.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        });

        currentImage.addEventListener('mouseup', () => {
            isDragging = false;
            const img = document.getElementById('mainImg');
            if (img) img.style.cursor = 'grab';
        });

        currentImage.addEventListener('mouseleave', () => {
            isDragging = false;
            const img = document.getElementById('mainImg');
            if (img) img.style.cursor = 'grab';
        });



        function selectImage(idx) {
            Array.from(varList.children).forEach(el => el.classList.remove('selected'));
            varList.children[idx].classList.add('selected');
            scale = 1;
            translateX = 0;
            translateY = 0;
            currentImage.innerHTML = `<img id = "mainImg" src = "${images[idx].src}" alt = "${images[idx].name}" style = "cursor: grab; transition: transform 0.1s;" />`;
            updateTransform();
        }
        renderThumbs();
    </script>

    <!-- 在 <body> 末尾添加右键菜单 DOM -->
    <ul id="customMenu" class="custom-menu" style="display:none;position:absolute;z-index:10000;">
        <li data-action="zoomToFit">Zoom to Fit</li>
        <li data-action="zoomToOriginal">Zoom to Original Size</li>
        <li data-action="linkViews" class="checked">Link Views</li>
        <li class="separator"></li>
        <li data-action="autoMaxContrast" class="checked">Auto Maximize Contrast</li>
        <li data-action="pseudoColor" class="checked">1-Channel Pseudo Color</li>
        <li data-action="ignoreAlpha" class="checked">4-Channel Ignore Alpha</li>
        <li class="separator"></li>
        <li data-action="hexDisplay" class="checked">Hexadecimal Display</li>
        <li class="separator"></li>
        <li data-action="copyPixel">Copy Pixel Address</li>
    </ul>

    <style>
        .custom-menu {
            min-width: 220px;
            background: #232323;
            border-radius: 6px;
            box-shadow: 0 2px 16px #000a;
            padding: 6px 0;
            margin: 0;
            list-style: none;
            font-size: 15px;
            color: #ccc;
            border: 1px solid #333;
        }

        .custom-menu li {
            padding: 6px 32px 6px 32px;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background 0.15s;
        }

        .custom-menu li:hover {
            background: #2a2d2e;
            color: #fff;
        }

        .custom-menu li.checked::before {
            content: "✔";
            position: absolute;
            left: 12px;
            color: #4fc3f7;
            font-size: 13px;
        }

        .custom-menu .separator {
            height: 1px;
            background: #333;
            margin: 4px 0;
            padding: 0;
            pointer-events: none;
        }
    </style>

    <script>
        const menu = document.getElementById('customMenu');
        document.addEventListener('contextmenu', function (e) {
            // 只在 mainView 区域弹出菜单
            const mainView = document.getElementById('mainView');
            if (mainView.contains(e.target)) {
                e.preventDefault();
                menu.style.display = 'block';
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
            } else {
                menu.style.display = 'none';
            }
        });
        document.addEventListener('click', function () {
            menu.style.display = 'none';
        });
        menu.addEventListener('click', function (e) {
            if (e.target.dataset.action) {
                // 处理菜单点击
                switch (e.target.dataset.action) {
                    case 'zoomToFit':
                        // TODO: 实现 Zoom to Fit
                        break;
                    case 'zoomToOriginal':
                        // TODO: 实现 Zoom to Original Size
                        break;
                    case 'linkViews':
                    case 'autoMaxContrast':
                    case 'pseudoColor':
                    case 'ignoreAlpha':
                    case 'hexDisplay':
                        // 切换勾选状态
                        e.target.classList.toggle('checked');
                        break;
                    case 'copyPixel':
                        // TODO: 实现 Copy Pixel Address
                        break;
                }
                menu.style.display = 'none';
            }
        });
    </script>
</body>

</html>